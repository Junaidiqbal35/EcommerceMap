{% extends "base.html" %}
{% block content %}
    <div id="map" style="height: 600px; width: 100%;"></div>
    {% endblock %}
    {% block extrascript %}
    <script>
    
        const map = L.map('map').setView([-27.4698, 153.0251], 8); // Centered in Queensland
        L.hash(map);
    
        L.Control.geocoder().addTo(map);
    
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
    
        
        fetch('/api/layers/')
            .then(response => response.json())
            .then(data => {
                console.log(data);
                data.forEach(layer => {
                    if (layer.server.url) {
                        
                        const dynamicLayer = L.esri.dynamicMapLayer({
                            url: layer.server.url
                        }).addTo(map);
    
                        
                        const bounds = [
                            [layer.server.extent_min_y, layer.server.extent_min_x],
                            [layer.server.extent_max_y, layer.server.extent_max_x]
                        ];
                        L.rectangle(bounds, { color: "blue", weight: 1 })
                            .addTo(map)
                            .bindPopup(`<strong>Layer:</strong> ${layer.name}`);
                    }
                });
            })
            .catch(err => console.error('Error fetching layers:', err));
    
        const marker = L.marker([-27.4698, 153.0251]).addTo(map);
        marker.bindPopup("<b>Welcome to Queensland!</b><br>Here's a sample marker.");
        
        const circle = L.circle([-27.5, 153], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 5000
        }).addTo(map);
        circle.bindPopup("This is a circle with a 5km radius.");
    
        
        const polygon = L.polygon([
            [-27.4, 152.9],
            [-27.5, 153.1],
            [-27.6, 152.95]
        ], { color: 'green' }).addTo(map);
        polygon.bindPopup("A simple polygon.");
    
        
        map.on('click', function (e) {
            const { lat, lng } = e.latlng;
    
            
            const clickMarker = L.marker([lat, lng]).addTo(map);
            clickMarker.bindPopup(`You clicked at latitude: ${lat.toFixed(5)}, longitude: ${lng.toFixed(5)}`).openPopup();
        });

        const markers = L.layerGroup();
    
        L.marker([-27.4, 153.0]).addTo(markers).bindPopup("Marker 1");
        L.marker([-27.6, 152.9]).addTo(markers).bindPopup("Marker 2");
        L.marker([-27.5, 153.1]).addTo(markers).bindPopup("Marker 3");
    
        markers.addTo(map);
    
        const overlays = {
            "Custom Markers": markers
        };
        L.control.layers(null, overlays).addTo(map);
    </script>    
    <!-- <script>
        // Initialize the map
        const map = L.map('map').setView([-27.4698, 153.0251], 8); // Centered in Queensland
        L.hash(map);

        // Add Geocoder
        L.Control.geocoder().addTo(map);

        // Base map
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Fetch and add layers from the backend
        fetch('/api/layers/')
            .then(response => response.json())
            .then(data => {
                console.log(data)
                data.forEach(layer => {
                    if (layer.server.url) {
                        // Add Esri dynamic map layer
                        const dynamicLayer = L.esri.dynamicMapLayer({
                            url: layer.server.url
                        }).addTo(map);

                        // Optional: Add bounds if available
                        const bounds = [
                            [layer.server.extent_min_y, layer.server.extent_min_x],
                            [layer.server.extent_max_y, layer.server.extent_max_x]
                        ];
                        L.rectangle(bounds, { color: "blue", weight: 1 })
                            .addTo(map)
                            .bindPopup(`Layer: ${layer.name}`);
                    }
                });
            })
            .catch(err => console.error('Error fetching layers:', err));
    </script> -->
{% endblock extrascript %}
